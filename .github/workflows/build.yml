name: Build Maxed-Out Linux Kernel ISO (on /tmp RAM disk)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # -------------------------------------------------
      # 1. Mount /tmp as tmpfs (4 GB RAM disk)
      # -------------------------------------------------
      - name: Mount /tmp as tmpfs (4 GB)
        run: |
          sudo mkdir -p /tmp
          sudo mount -t tmpfs -o size=4G tmpfs /tmp
          echo "tmpfs mounted: $(df -h /tmp | tail -1)"

      # -------------------------------------------------
      # 2. Checkout kernel source (to DEFAULT workspace path)
      # -------------------------------------------------
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          # No 'path' = defaults to $GITHUB_WORKSPACE (e.g., /home/runner/work/linux-fork/linux-fork)

      # -------------------------------------------------
      # 3. Symlink /tmp/linux-src → workspace (for compatibility)
      # -------------------------------------------------
      - name: Symlink source dir
        run: |
          ln -s "$GITHUB_WORKSPACE" /tmp/linux-src
          echo "Symlinked /tmp/linux-src → $GITHUB_WORKSPACE"

      # -------------------------------------------------
      # 4. Install build tools
      # -------------------------------------------------
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc bison flex libelf-dev libssl-dev \
            libncurses5-dev git wget xorriso grub-pc-bin mtools \
            qemu-system-x86 cpio

      # -------------------------------------------------
      # 5. Generate maximal config (in workspace)
      # -------------------------------------------------
      - name: Generate maximal config
        run: |
          cd "$GITHUB_WORKSPACE"   # or cd /tmp/linux-src (symlink works)

          make defconfig

          # Enable EVERYTHING as module where possible
          ./scripts/config --module CONFIG_*  || true
          ./scripts/config --enable CONFIG_*   || true

          # Force debug, tracing, etc.
          ./scripts/config --enable CONFIG_DEBUG_INFO
          ./scripts/config --enable CONFIG_KASAN
          ./scripts/config --enable CONFIG_KCSAN
          ./scripts/config --enable CONFIG_DEBUG_KERNEL
          ./scripts/config --enable CONFIG_FTRACE
          ./scripts/config --set-val CONFIG_NR_CPUS 4096
          ./scripts/config --set-str CONFIG_LOCALVERSION "-maxed"

          cp .config .config-maxed

      # -------------------------------------------------
      # 6. Build kernel and modules (source in workspace, modules in /tmp)
      # -------------------------------------------------
      - name: Build kernel and modules
        run: |
          cd "$GITHUB_WORKSPACE"

          make -j$(nproc) bzImage
          make -j$(nproc) modules

          # Install modules into /tmp (RAM disk for speed)
          mkdir -p /tmp/kernel-modules
          make INSTALL_MOD_PATH=/tmp/kernel-modules modules_install

          # Build initramfs with ALL modules (in /tmp)
          mkdir -p /tmp/initramfs/{bin,lib,lib/modules,dev,proc,sys}
          cp -a /tmp/kernel-modules/lib/modules/* /tmp/initramfs/lib/modules/

          # Minimal busybox
          wget -O /tmp/busybox https://busybox.net/downloads/binaries/1.36.1/busybox-x86_64
          chmod +x /tmp/busybox
          cp /tmp/busybox /tmp/initramfs/bin/
          ln -s busybox /tmp/initramfs/bin/sh

          # init script
          cat > /tmp/initramfs/init <<'EOF'
          #!/bin/sh
          mount -t proc none /proc
          mount -t sysfs none /sys
          echo "Maxed-out Linux booted!"
          exec /bin/sh
          EOF
          chmod +x /tmp/initramfs/init

          # Pack initramfs
          (cd /tmp/initramfs && find . | cpio -o -H newc | gzip > /tmp/initramfs.cpio.gz)

      # -------------------------------------------------
      # 7. Create bootable ISO in /tmp
      # -------------------------------------------------
      - name: Create ISO
        run: |
          cd "$GITHUB_WORKSPACE"
          KERNEL_VER=$(make kernelrelease)
          ISO_NAME="linux-${KERNEL_VER}-maxed.iso"
          ISO_PATH="/tmp/$ISO_NAME"

          mkdir -p /tmp/iso/boot/grub
          cp arch/x86/boot/bzImage /tmp/iso/boot/vmlinuz
          cp /tmp/initramfs.cpio.gz /tmp/iso/boot/initrd.gz

          cat > /tmp/iso/boot/grub/grub.cfg <<EOF
          set timeout=3
          menuentry "Linux ${KERNEL_VER} (maxed)" {
              linux /boot/vmlinuz root=/dev/ram0 rdinit=/init
              initrd /boot/initrd.gz
          }
          EOF

          grub-mkrescue -o "$ISO_PATH" /tmp/iso
          echo "ISO created: $ISO_PATH ($(du -h $ISO_PATH | cut -f1))"
          echo "ISO_PATH=$ISO_PATH" >> $GITHUB_ENV
          echo "ISO_NAME=$ISO_NAME" >> $GITHUB_ENV

      # -------------------------------------------------
      # 8. Upload ISO as artifact
      # -------------------------------------------------
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ${{ env.ISO_PATH }}

      # -------------------------------------------------
      # 9. (Optional) Create GitHub Release
      # -------------------------------------------------
      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iso-${{ github.run_number }}
          name: Maxed Kernel ISO #${{ github.run_number }}
          files: ${{ env.ISO_PATH }}
          draft: false
          prerelease: false

      # -------------------------------------------------
      # 10. Cleanup (unmount tmpfs)
      # -------------------------------------------------
      - name: Unmount tmpfs
        if: always()
        run: |
          sudo umount /tmp || true
          echo "/tmp tmpfs unmounted"
